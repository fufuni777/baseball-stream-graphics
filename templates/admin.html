<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ£’çƒä¸­æ§å° (ä¿®æ­£ç‰ˆ)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* ================= å…¨åŸŸæ¨£å¼ ================= */
    html, body { 
        font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; 
        background: #1a1a1a; 
        color: #ddd; 
        margin: 0; 
        padding: 10px; 
        padding-bottom: 80px; 
    }
    h1, h2, h3 { margin: 5px 0; font-weight: bold; }
    input, select { 
        padding: 6px; 
        background: #333; 
        color: white; 
        border: 1px solid #555; 
        border-radius: 4px; 
        font-size: 1rem;
    }
    input:focus, select:focus { border-color: #f1c40f; outline: none; }
    
    button { 
        cursor: pointer; padding: 6px 12px; border-radius: 4px; border: none; 
        font-weight: bold; font-size: 0.95rem; transition: filter 0.2s;
    }
    button:hover { filter: brightness(1.2); }
    button:active { transform: scale(0.98); }

    .btn-green { background: #27ae60; color: white; }
    .btn-red { background: #c0392b; color: white; }
    .btn-blue { background: #2980b9; color: white; }
    .btn-yellow { background: #f39c12; color: black; }
    .btn-gray { background: #7f8c8d; color: white; }

    .main-container { display: flex; flex-wrap: wrap; gap: 15px; max-width: 1400px; margin: 0 auto; }
    .section-card { 
        background: #2c2c2c; border: 1px solid #444; border-radius: 8px; 
        padding: 15px; flex: 1 1 350px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .section-title { 
        border-bottom: 2px solid #555; padding-bottom: 8px; margin-bottom: 12px; 
        font-size: 1.1rem; color: #f1c40f; font-weight: bold;
        display: flex; justify-content: space-between; align-items: center;
    }

    .counter-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .counter-label { width: 50px; font-weight: bold; }
    .counter-val { font-size: 1.5rem; font-weight: bold; width: 40px; text-align: center; display: inline-block; color: #fff; }
    .base-check { transform: scale(1.5); margin-right: 5px; }
    .base-label { margin-right: 15px; cursor: pointer; font-size: 1.1rem;}

    .score-display { font-size: 3.5rem; font-weight: 900; margin: 10px 0; }
    .team-input-row { display: flex; gap: 5px; justify-content: center; align-items: center; }
    .logo-input { width: 48%; font-size: 0.8rem; color: #aaa; }

    .box-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px; text-align: center; margin-bottom: 10px; }
    .box-header { font-size: 0.9rem; color: #aaa; padding-bottom: 2px;}
    .box-cell input { width: 100%; text-align: center; font-size: 1.2rem; padding: 4px 0; background: #444; border: 1px solid #555; }
    .box-cell input:focus { background: #555; border-color: #f1c40f; }

    .team-control-row { border-left: 6px solid #555; padding-left: 15px; }
    .team-away { border-color: #3498db; } 
    .team-home { border-color: #27ae60; } 

    .lineup-toggle { width: 100%; text-align: left; background: #3a3a3a; margin-top: 10px; font-size: 0.9rem; }
    .lineup-area { display: none; background: #222; padding: 10px; border-radius: 4px; margin-top: 5px; border: 1px solid #444; }
    .lineup-area.show { display: block; }
    .lineup-row { display: flex; align-items: center; margin-bottom: 5px; }
    .lineup-num { width: 25px; color: #888; font-weight: bold; text-align: right; margin-right: 8px; }

    .rhe-ctrl { display: flex; gap: 15px; background: #222; padding: 8px; border-radius: 4px; margin-bottom: 10px; align-items: center; }
    .rhe-item span { color: #aaa; margin-right: 5px; font-size: 0.9rem; }

    /* è¨ˆæ™‚å™¨æ¨£å¼ */
    .timer-display-admin {
        font-family: 'Courier New', monospace; font-size: 2.5rem; font-weight: bold;
        background: #000; color: #0f0; padding: 10px; border-radius: 5px;
        text-align: center; margin: 10px 0; border: 2px solid #444;
    }
    .timer-controls { display: flex; gap: 10px; justify-content: center; }
    .timer-alert-mode { color: #fff; background: #c0392b; }

    /* åº•éƒ¨æ‡¸æµ®åˆ— */
    .submit-bar {
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: rgba(20, 20, 20, 0.95); padding: 12px; 
        border-top: 1px solid #f1c40f; z-index: 999;
        display: flex; justify-content: center; align-items: center; gap: 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
    }
    .submit-btn { 
        background: linear-gradient(135deg, #e74c3c, #c0392b); 
        color: white; font-size: 1.4rem; padding: 12px 60px; border-radius: 50px; 
        box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4); letter-spacing: 1px;
    }
    .status-light { width: 12px; height: 12px; border-radius: 50%; background: #555; display: inline-block; margin-right: 5px; }
    .status-connected { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }

    #toast {
        position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
        background: #2ecc71; color: #000; padding: 5px 15px; border-radius: 20px;
        font-weight: bold; opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
</style>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<h1 style="text-align:center; color:#f1c40f;">âš¾ æ¯”è³½ä¸­æ§å°</h1>

<div class="main-container">
    <div class="section-card">
        <div class="section-title">ç‹€æ…‹æ§åˆ¶ (BSO)</div>
        <div class="counter-row">
            <span class="counter-label" style="color:#3498db">Ball</span>
            <button class="btn-blue" onclick="adj('balls', 1)">+1</button>
            <span class="counter-val" id="disp_balls">0</span>
            <button class="btn-blue" onclick="adj('balls', -1)">-1</button>
            <button class="btn-gray" style="margin-left:auto" onclick="adj('balls', -99)">æ­¸é›¶</button>
        </div>
        <div class="counter-row">
            <span class="counter-label" style="color:#f1c40f">Strike</span>
            <button class="btn-yellow" onclick="adj('strikes', 1)">+1</button>
            <span class="counter-val" id="disp_strikes">0</span>
            <button class="btn-yellow" onclick="adj('strikes', -1)">-1</button>
            <button class="btn-gray" style="margin-left:auto" onclick="adj('strikes', -99)">æ­¸é›¶</button>
        </div>
        <div class="counter-row">
            <span class="counter-label" style="color:#e74c3c">Out</span>
            <button class="btn-red" onclick="adj('outs', 1)">+1</button>
            <span class="counter-val" id="disp_outs">0</span>
            <button class="btn-red" onclick="adj('outs', -1)">-1</button>
            <button class="btn-gray" style="margin-left:auto" onclick="adj('outs', -99)">æ­¸é›¶</button>
        </div>
        <hr style="border-color:#444; margin: 15px 0;">
        <div style="display:flex; justify-content:space-around;">
            <label class="base-label"><input type="checkbox" class="base-check" id="base1">ä¸€å£˜</label>
            <label class="base-label"><input type="checkbox" class="base-check" id="base2">äºŒå£˜</label>
            <label class="base-label"><input type="checkbox" class="base-check" id="base3">ä¸‰å£˜</label>
        </div>
    </div>

    <div class="section-card">
        <div class="section-title">
            å±€æ•¸èˆ‡æŠ•æ‰“
            <!-- å±€æ•¸æ§åˆ¶æ”¹ç‚ºæ•¸å­—+æŒ‰éˆ• -->
            <div style="font-size:0.8rem; font-weight:normal;">
               å±€æ•¸æ§åˆ¶
            </div>
        </div>

        <div class="counter-row">
            <span style="width:50px;">å±€æ•¸:</span>
            <button class="btn-gray" onclick="adjInning(-1)">-</button>
            <span id="disp_inn_num" class="counter-val" style="width:40px;">1</span>
            <button class="btn-gray" onclick="adjInning(1)">+</button>
            <button class="btn-blue" id="btn_inn_half" onclick="toggleInningHalf()" style="margin-left:5px;">ä¸Š</button>
        </div>

        <div class="counter-row">
            <span style="width:50px;">æŠ•æ‰‹:</span>
            <select id="pitcher_select" style="flex:1; font-size:1.1rem;">
                <option value="">(è«‹å…ˆé¸æ“‡çƒéšŠ)</option>
            </select>
        </div>
        <div class="counter-row">
            <span style="width:50px;">NP:</span>
            <button class="btn-gray" onclick="adj('np', -1)">-</button>
            <span class="counter-val" id="disp_np" style="font-size:1.2rem; width:50px;">0</span>
            <button class="btn-gray" onclick="adj('np', 1)">+</button>
        </div>
        <hr style="border-color:#444;">
        <div class="counter-row">
            <span style="width:50px;">æ‰“è€…:</span>
            <select id="batter_select" style="flex:1; font-size:1.1rem;">
                <option value="">(è«‹å…ˆå¾åå–®è¨­å®š)</option>
            </select>
        </div>
        <div class="counter-row">
            <select id="pa_result" style="flex:1;">
                <option value="">-- æ‰“å¸­çµæœ --</option>
                <option value="1B">ä¸€å®‰ (1B)</option>
                <option value="2B">äºŒå®‰ (2B)</option>
                <option value="3B">ä¸‰å®‰ (3B)</option>
                <option value="HR">å…¨å£˜æ‰“ (HR)</option>
                <option value="BB">ä¿é€ (BB)</option>
                <option value="K">ä¸‰æŒ¯ (K)</option>
                <option value="FO">é£›çƒ (FO)</option>
                <option value="GO">æ»¾åœ° (GO)</option>
                <option value="E">å¤±èª¤ (E)</option>
            </select>
            <button class="btn-green" onclick="addPA()">ç´€éŒ„</button>
        </div>
        <div style="background:#222; padding:5px; font-size:0.85rem; color:#aaa; border-radius:4px; min-height:20px;" id="pa_history">
            (æš«ç„¡æ‰“å¸­ç´€éŒ„)
        </div>
    </div>

    <div class="section-card" style="text-align:center;">
        <div class="section-title">â±ï¸ æ¯”è³½è¨ˆæ™‚å™¨</div>
        
        <div class="timer-display-admin" id="admin_timer_display">02:30:00</div>
        
        <div style="margin-bottom:10px;">
            è¨­å®šæ™‚é–“: 
            <input type="number" id="timer_h" value="2" style="width:40px; text-align:center;"> æ™‚
            <input type="number" id="timer_m" value="30" style="width:40px; text-align:center;"> åˆ†
            <button class="btn-gray" onclick="resetTimer()">é‡ç½®</button>
        </div>

        <div class="timer-controls">
            <button class="btn-green" onclick="startTimer()">â–¶ é–‹å§‹</button>
            <button class="btn-yellow" onclick="pauseTimer()">â¸ æš«åœ</button>
        </div>
        <div style="margin-top:10px; font-size:0.8rem; color:#888;">
            * å€’æ•¸ä¸­æœƒè‡ªå‹•åŒæ­¥ï¼Œå‰©15åˆ†è®Šç´…ã€‚
        </div>
    </div>

    <div class="section-card" style="text-align:center;">
        <div class="section-title">å³æ™‚ç¸½åˆ† (å”¯è®€)</div>
        <div class="team-input-row">
            <input id="away_team_input" placeholder="å®¢éšŠåç¨±" style="width:120px; text-align:center; font-weight:bold;" readonly>
            <span style="margin:0 10px; color:#888;">vs</span>
            <input id="home_team_input" placeholder="ä¸»éšŠåç¨±" style="width:120px; text-align:center; font-weight:bold;" readonly>
        </div>
        <div class="score-display">
            <span style="color:#3498db" id="total_away">0</span>
            <span style="color:#555; font-size:2rem;">-</span>
            <span style="color:#27ae60" id="total_home">0</span>
        </div>
        <div style="display:flex; gap:5px;">
            <input id="away_logo" class="logo-input" placeholder="å®¢éšŠæª”å">
            <input id="home_logo" class="logo-input" placeholder="ä¸»éšŠæª”å">
        </div>
        <div style="margin-top:10px; font-size:0.8rem; color:#888;">* è¼¸å…¥æª”åæœƒè‡ªå‹•è£œ /static/logos/</div>
    </div>
</div>

<h2 style="text-align:center; margin-top:30px; color:#aaa; border-top:1px solid #444; padding-top:20px;">ğŸ“‹ è©³ç´°è¨˜åˆ†æ¿ & åå–®è¨­å®š</h2>

<div class="main-container">
    <div class="section-card team-control-row team-away">
        <h3 style="color:#3498db; margin-top:0;">å®¢éšŠ (Away)</h3>
        <select id="sel-away-db" onchange="applyTeamDB('away')" style="width:100%; margin-bottom:10px; background:#202b35; border-color:#3498db;">
            <option value="">å¾è³‡æ–™åº«è¼‰å…¥çƒéšŠ...</option>
        </select>
        <div class="rhe-ctrl">
            <div class="rhe-item"><span>å®‰æ‰“(H)</span><input type="number" id="away_H" value="0" style="width:50px; text-align:center;" min="0"></div>
            <div class="rhe-item"><span>å¤±èª¤(E)</span><input type="number" id="away_E" value="0" style="width:50px; text-align:center;" min="0"></div>
        </div>
        <div style="background:#222; padding:10px; border-radius:6px; margin-bottom:10px;">
            <div class="box-grid">
                <div class="box-header">1</div><div class="box-header">2</div><div class="box-header">3</div>
                <div class="box-header">4</div><div class="box-header">5</div><div class="box-header">6</div>
                <div class="box-header">7</div><div class="box-header">8</div><div class="box-header">9</div>
            </div>
            <div class="box-grid">
                <script>for(let i=0; i<9; i++) document.write(`<div class="box-cell"><input type="number" class="score-inp-away" data-idx="${i}" value="0" min="0" onclick="this.select()" oninput="recalcTotal()"></div>`);</script>
            </div>
            <div style="text-align:right; margin-top:5px;"><button class="btn-yellow" style="font-size:0.8rem;" onclick="boxScoreAdj('away', 1)">ç›®å‰å±€æ•¸å¾—åˆ† +1</button></div>
        </div>
        <button class="lineup-toggle" onclick="document.getElementById('lineup-away').classList.toggle('show')">è¨­å®š 9 äººåå–® â–¼</button>
        <div id="lineup-away" class="lineup-area"></div>
    </div>

    <div class="section-card team-control-row team-home">
        <h3 style="color:#27ae60; margin-top:0;">ä¸»éšŠ (Home)</h3>
        <select id="sel-home-db" onchange="applyTeamDB('home')" style="width:100%; margin-bottom:10px; background:#1e3324; border-color:#27ae60;">
            <option value="">å¾è³‡æ–™åº«è¼‰å…¥çƒéšŠ...</option>
        </select>
        <div class="rhe-ctrl">
            <div class="rhe-item"><span>å®‰æ‰“(H)</span><input type="number" id="home_H" value="0" style="width:50px; text-align:center;" min="0"></div>
            <div class="rhe-item"><span>å¤±èª¤(E)</span><input type="number" id="home_E" value="0" style="width:50px; text-align:center;" min="0"></div>
        </div>
        <div style="background:#222; padding:10px; border-radius:6px; margin-bottom:10px;">
            <div class="box-grid">
                <div class="box-header">1</div><div class="box-header">2</div><div class="box-header">3</div>
                <div class="box-header">4</div><div class="box-header">5</div><div class="box-header">6</div>
                <div class="box-header">7</div><div class="box-header">8</div><div class="box-header">9</div>
            </div>
            <div class="box-grid">
                <script>for(let i=0; i<9; i++) document.write(`<div class="box-cell"><input type="number" class="score-inp-home" data-idx="${i}" value="0" min="0" onclick="this.select()" oninput="recalcTotal()"></div>`);</script>
            </div>
            <div style="text-align:right; margin-top:5px;"><button class="btn-yellow" style="font-size:0.8rem;" onclick="boxScoreAdj('home', 1)">ç›®å‰å±€æ•¸å¾—åˆ† +1</button></div>
        </div>
        <button class="lineup-toggle" onclick="document.getElementById('lineup-home').classList.toggle('show')">è¨­å®š 9 äººåå–® â–¼</button>
        <div id="lineup-home" class="lineup-area"></div>
    </div>
</div>

<div class="submit-bar">
    <div style="color:#aaa; font-size:0.9rem; display:flex; align-items:center;">
        <span id="cxn_light" class="status-light"></span>
        <span id="cxn_text">æœªé€£ç·š</span>
    </div>
    <div style="position:relative;">
        <button class="submit-btn" onclick="broadcast()">ğŸ”´ å»£æ’­æ›´æ–°</button>
        <div id="toast">âœ… æ›´æ–°å·²é€å‡º</div>
    </div>
    <div style="color:#555; font-size:0.8rem; position:absolute; right:20px;">Tips: Enter=é€å‡º | 1,2,3=B,S,O | +/-=NP</div>
</div>

<!-- ================= è³‡æ–™æ³¨å…¥å€ ================= -->
<script id="data-db" type="application/json">
{{ players_by_team | tojson }}
</script>

<script id="data-state" type="application/json">
{{ data | tojson }}
</script>

<script>
// ================= 1. åˆå§‹åŒ– =================
function loadJSONData(id, defaultVal) {
    const el = document.getElementById(id);
    if (!el) return defaultVal;
    const text = el.textContent.trim();
    if (text === '' || text.startsWith('{' + '{')) {
        console.log(`[Admin] Using Mock Data for ${id} (Preview Mode)`);
        return defaultVal;
    }
    try { return JSON.parse(text); } 
    catch (e) { console.error(`[Admin] Parse error for ${id}:`, e); return defaultVal; }
}

const MOCK_DB = { "ç¯„ä¾‹éšŠ": ["[1] æŠ•æ‰‹", "[2] æ‰“è€…"] };
const MOCK_STATE = {
    inning: "1ä¸Š", balls: 0, strikes: 0, outs: 0, bases: [false, false, false], np: 0,
    away_team: "å®¢éšŠ", home_team: "ä¸»éšŠ", away_score: 0, home_score: 0,
    batter_pa_recent: [],
    box_away: { name: "å®¢éšŠ", scores: [0]*9, H:0, E:0, lineup: [] },
    box_home: { name: "ä¸»éšŠ", scores: [0]*9, H:0, E:0, lineup: [] },
    timer_str: "02:30:00", timer_alert: false
};

const DB = loadJSONData('data-db', MOCK_DB);
let state = loadJSONData('data-state', MOCK_STATE);

// å…¼å®¹ï¼šDB å…§å¯èƒ½æ˜¯å­—ä¸²ï¼Œä¹Ÿå¯èƒ½æ˜¯ {num, name}
function getPlayerName(p) {
    return (typeof p === 'string') ? p : (p.name || '');
}

function getPlayerNum(p) {
    if (typeof p === 'string') return '';
    return p.num || p.number || '';
}

// åˆå§‹åŒ–å±€æ•¸ç‹€æ…‹
if(!state.inning) state.inning = "1ä¸Š";
state.inn_num = parseInt(state.inning) || 1;
state.inn_half = state.inning.includes("ä¸‹") ? "ä¸‹" : "ä¸Š";

const socket = io();

// ===== DOM Elements =====
const elPitcherSelect = document.getElementById('pitcher_select');
const elBatterSelect  = document.getElementById('batter_select');
const elAwayDB = document.getElementById('sel-away-db');
const elHomeDB = document.getElementById('sel-home-db');

const elDispBalls = document.getElementById('disp_balls');
const elDispStrikes = document.getElementById('disp_strikes');
const elDispOuts = document.getElementById('disp_outs');
const elBase1 = document.getElementById('base1');
const elBase2 = document.getElementById('base2');
const elBase3 = document.getElementById('base3');
const elDispNP = document.getElementById('disp_np');

const elDispInnNum = document.getElementById('disp_inn_num');
const elBtnInnHalf = document.getElementById('btn_inn_half');

const elAwayTeamInp = document.getElementById('away_team_input');
const elHomeTeamInp = document.getElementById('home_team_input');
const elAwayLogoInp = document.getElementById('away_logo');
const elHomeLogoInp = document.getElementById('home_logo');
const elTotalAway = document.getElementById('total_away');
const elTotalHome = document.getElementById('total_home');
const elAdminTimerDisplay = document.getElementById('admin_timer_display');
const elToast = document.getElementById('toast');

// Timer
let timerInterval = null;
let totalSeconds = 2 * 3600 + 30 * 60; 
let isRunning = false;

// ================= 2. UI Init =================
function initLineupHTML(side) {
    const container = document.getElementById(`lineup-${side}`);
    const selDB = document.getElementById(`sel-${side}-db`);
    if(DB) Object.keys(DB).forEach(team => selDB.innerHTML += `<option value="${team}">${team}</option>`);
    let html = '';
    for(let i=1; i<=9; i++) {
        // åŠ å…¥ onchange è§¸ç™¼æ‰“è€…é¸å–®æ›´æ–°
        html += `<div class="lineup-row"><div class="lineup-num">${i}.</div><select id="lineup-${side}-${i-1}" style="flex:1; font-size:0.9rem;" onchange="updatePitcherBatterLists()"><option value="(å¾…å®š)">(å¾…å®š)</option></select></div>`;
    }
    container.innerHTML = html;
}
initLineupHTML('away');
initLineupHTML('home');

// ================= 3. Socket Events =================
socket.on('connect', () => {
    document.getElementById('cxn_light').classList.add('status-connected');
    document.getElementById('cxn_text').innerText = "ä¼ºæœå™¨å·²é€£ç·š";
    document.getElementById('cxn_text').style.color = "#ddd";
});

socket.on('disconnect', () => {
    document.getElementById('cxn_light').classList.remove('status-connected');
    document.getElementById('cxn_text').innerText = "æ–·ç·šé‡é€£ä¸­...";
    document.getElementById('cxn_text').style.color = "red";
});

socket.on('update', (data) => {
    if(data.np !== undefined) state.np = data.np;
    if(data.timer_str) elAdminTimerDisplay.innerText = data.timer_str;
});

socket.on("player_stats", (data) => {
    console.log("[Admin] recv player_stats:", data);
    const pName = data.pitcher;
    const bName = data.batter;

    // æŠ•æ‰‹ NP
    if (pName && pName === elPitcherSelect.value) {
        state.pitcher = pName;
        state.np = data.np || 0;
    }

    // æ‰“è€…æ‰“å¸­ç´€éŒ„
    if (bName && bName === elBatterSelect.value) {
        state.batter = bName;
        state.batter_pa_recent = Array.isArray(data.batter_pa_recent)
            ? data.batter_pa_recent
            : [];
    }

    renderAll();
});

// ================= 4. Logic =================

// åˆ‡æ›é¸å–®
elPitcherSelect.addEventListener('change', () => { state.pitcher = elPitcherSelect.value; requestPlayerStats(); });
elBatterSelect.addEventListener('change', () => { state.batter = elBatterSelect.value; requestPlayerStats(); });

function requestPlayerStats() {
    const p = elPitcherSelect.value || "";
    const b = elBatterSelect.value || "";
    if (!p && !b) return;
    // â­ ä¸è¦å†æ¸…ç©ºæ‰“å¸­ç´€éŒ„ï¼Œè®“ç›®å‰é€™å ´æ¯”è³½çš„ç´€éŒ„ç•™åœ¨å‰ç«¯
    socket.emit("get_player_stats", { pitcher: p, batter: b });
}


// ================= 5. Render =================
function renderBSO() {
    elDispBalls.innerText   = state.balls;
    elDispStrikes.innerText = state.strikes;
    elDispOuts.innerText    = state.outs;
    elBase1.checked = !!(state.bases && state.bases[0]);
    elBase2.checked = !!(state.bases && state.bases[1]);
    elBase3.checked = !!(state.bases && state.bases[2]);
    elDispNP.innerText = state.np;
}

function renderGameInfo() {
    elDispInnNum.innerText = state.inn_num;
    elBtnInnHalf.innerText = state.inn_half;
    // å±€æ•¸é¡¯ç¤ºæ–‡å­—
    const innStr = `${state.inn_num}${state.inn_half}`;
    state.inning = innStr;
}

function renderTeams() {
    elAwayTeamInp.value = state.away_team || '';
    elHomeTeamInp.value = state.home_team || '';
    elAwayLogoInp.value = state.away_logo_url || '';
    elHomeLogoInp.value = state.home_logo_url || '';
}

function renderTotals() {
    elTotalAway.innerText = state.away_score ?? 0;
    elTotalHome.innerText = state.home_score ?? 0;
}

function renderAll() {
    renderBSO();
    renderGameInfo();
    renderTeams();
    renderTotals();
    renderTeamBox('away');
    renderTeamBox('home');
    renderPAHistory();
}

function renderTeamBox(side) {
    const box = state[`box_${side}`];
    if(!box) return;
    document.getElementById(`${side}_H`).value = box.H;
    document.getElementById(`${side}_E`).value = box.E;
    box.scores.forEach((s, idx) => {
        const el = document.querySelector(`.score-inp-${side}[data-idx="${idx}"]`);
        if(el) el.value = s;
    });
}

function renderPAHistory() {
    const container = document.getElementById('pa_history');
    const list = state.batter_pa_recent || [];
    if (!container) return;
    if (list.length === 0) { container.innerHTML = '<span style="color:#666;">(æš«ç„¡ç´€éŒ„)</span>'; return; }
    container.innerHTML = list.map(item => `<div><span style="color:#f1c40f;">[${item.inning}]</span> ${item.result}</div>`).join("");
}

// ================= 6. Timer =================
function updateTimerDisplay() {
    let h = Math.floor(totalSeconds / 3600);
    let m = Math.floor((totalSeconds % 3600) / 60);
    let s = totalSeconds % 60;
    let str = (h<10?"0"+h:h)+":"+(m<10?"0"+m:m)+":"+(s<10?"0"+s:s);
    elAdminTimerDisplay.innerText = str;
    const isAlert = totalSeconds <= 900;
    elAdminTimerDisplay.classList.toggle('timer-alert-mode', isAlert);
    socket.emit('update', { timer_str: str, timer_alert: isAlert });
}
function startTimer() { if(isRunning) return; isRunning=true; timerInterval = setInterval(() => { if(totalSeconds>0){totalSeconds--;updateTimerDisplay();}else{pauseTimer();} }, 1000); }
function pauseTimer() { isRunning=false; clearInterval(timerInterval); }
function resetTimer() { pauseTimer(); totalSeconds = (parseInt(document.getElementById('timer_h').value)||0)*3600 + (parseInt(document.getElementById('timer_m').value)||0)*60; updateTimerDisplay(); }
resetTimer();

// ================= 7. Operations =================
function buildLogoPath(raw) {
    if (!raw) return "";
    let val = raw.trim();
    if (val.startsWith('/') || val.startsWith('http')) return val;
    return `/static/logos/${val}`;
}

// æ›´æ–°ä¸‹æ‹‰é¸å–®
// æ›´æ–°æŠ•æ‰‹ / æ‰“è€…ä¸‹æ‹‰é¸å–®
function updatePitcherBatterLists() {
    const inningStr = state.inning || "1ä¸Š";
    const isTop = inningStr.includes("ä¸Š");

    const awayTeamName = elAwayDB.value;   // å®¢éšŠåç¨± (å¾ DB é¸å–®)
    const homeTeamName = elHomeDB.value;   // ä¸»éšŠåç¨±

    // æŠ•æ‰‹ä¾ç…§ã€Œå®ˆå‚™æ–¹ã€çƒéšŠ
    const pitcherTeamName = isTop ? homeTeamName : awayTeamName;
    // æ‰“è€…ä¾ç…§ã€Œé€²æ”»æ–¹ã€çš„ 9 äººåå–®
    const batterSide = isTop ? 'away' : 'home';   // ä¸Šï¼šå®¢éšŠæ‰“ï¼›ä¸‹ï¼šä¸»éšŠæ‰“

    // ---- æŠ•æ‰‹ï¼šç…§èˆŠï¼Œå¾æ•´éšŠåå–®(DB)å¡« ----
    const fillPitcherFromDB = (selectEl, teamName) => {
        const currentVal = selectEl.value;
        selectEl.innerHTML = '<option value="">--é¸æ“‡--</option>';

        const roster = DB[teamName] || [];
        roster.forEach(p => {
            const name = getPlayerName(p);      // ç´”åå­—
            const num  = getPlayerNum(p);       // èƒŒè™Ÿ(å¯èƒ½ç©º)
            const text = num ? `${num} ${name}` : name; // é¡¯ç¤ºç”¨æ–‡å­—

            const opt = new Option(text, name); // â­ value åªæ”¾åå­—
            selectEl.add(opt);
        });

        if ([...selectEl.options].some(o => o.value === currentVal)) {
            selectEl.value = currentVal;
        }
    };

    // ---- æ‰“è€…ï¼šæ”¹æˆå¾è©² side çš„ 9 äººåå–®æŠ“ ----
    const fillBatterFromLineup = (selectEl, side) => {
        const currentVal = selectEl.value;
        selectEl.innerHTML = '<option value="">--é¸æ“‡--</option>';

        for (let i = 0; i < 9; i++) {
            const lineupSel = document.getElementById(`lineup-${side}-${i}`);
            if (!lineupSel) continue;

            const nameVal = lineupSel.value;
            if (!nameVal || nameVal === '(å¾…å®š)') continue;

            // é¡¯ç¤ºæ–‡å­—æ²¿ç”¨ lineup çš„ option æ–‡å­— (æœƒæœ‰èƒŒè™Ÿ)
            const text = lineupSel.options[lineupSel.selectedIndex].text || nameVal;

            const opt = new Option(text, nameVal);  // â­ value ä»ç„¶åªæ”¾åå­—
            selectEl.add(opt);
        }

        if ([...selectEl.options].some(o => o.value === currentVal)) {
            selectEl.value = currentVal;
        }
    };

    const savedPitcher = state.pitcher || elPitcherSelect.value;
    const savedBatter  = state.batter  || elBatterSelect.value;

    // å…ˆé‡å»ºé¸å–®
    fillPitcherFromDB(elPitcherSelect, pitcherTeamName);
    fillBatterFromLineup(elBatterSelect, batterSide);

    // å„˜é‡ä¿ç•™åŸæœ¬é¸å–çš„åå­—
    if (savedPitcher && [...elPitcherSelect.options].some(o => o.value === savedPitcher)) {
        elPitcherSelect.value = savedPitcher;
    }
    if (savedBatter && [...elBatterSelect.options].some(o => o.value === savedBatter)) {
        elBatterSelect.value = savedBatter;
    }
}


function applyTeamDB(side) {
    const teamName = document.getElementById(`sel-${side}-db`).value;
    if (!teamName) return;

    document.getElementById(`${side}_team_input`).value = teamName;
    const players = DB[teamName] || [];

    for (let i = 0; i < 9; i++) {
        const sel = document.getElementById(`lineup-${side}-${i}`);
        const oldVal = sel.value;
        sel.innerHTML = '<option value="(å¾…å®š)">(å¾…å®š)</option>';

        players.forEach(p => {
            const name = getPlayerName(p);
            const num  = getPlayerNum(p);
            const text = num ? `${num} ${name}` : name;
            const opt  = new Option(text, name); // â­ value = åå­—
            sel.add(opt);
        });

        // ç›¡é‡ä¿ç•™åŸæœ¬çš„åå­—é¸æ“‡
        if (players.some(p => getPlayerName(p) === oldVal)) {
            sel.value = oldVal;
        }
    }

    updatePitcherBatterLists(); // è®“æŠ•æ‰“ä¸‹æ‹‰ä¹ŸåŒæ­¥
}


function adj(key, delta) {
    if (delta === -99) state[key] = 0;
    else state[key] = Math.max(0, (state[key] || 0) + delta);

    if (key === 'balls' && state.balls > 3) state.balls = 0;
    if (key === 'strikes' && state.strikes > 2) state.strikes = 0;
    if (key === 'outs' && state.outs > 2) state.outs = 0;

    // â­ NPï¼šåŒæ­¥å­˜åˆ°å¾Œç«¯
    if (key === 'np') {
        const pitcherName = state.pitcher || elPitcherSelect.value || "";
        if (pitcherName) {
            socket.emit("save_pitcher_state", {
                pitcher: pitcherName,
                np: state.np
            });
        }
    }

    renderAll();
}


// å±€æ•¸èª¿æ•´é‚è¼¯
function adjInning(delta) {
    let n = state.inn_num + delta;
    if(n < 1) n = 1;
    state.inn_num = n;
    state.inning = `${state.inn_num}${state.inn_half}`;
    updatePitcherBatterLists();
    renderAll();
}

function toggleInningHalf() {
    state.inn_half = (state.inn_half === "ä¸Š") ? "ä¸‹" : "ä¸Š";
    state.inning = `${state.inn_num}${state.inn_half}`;
    updatePitcherBatterLists();
    renderAll();
}

function boxScoreAdj(side, delta) {
    const idx = state.inn_num - 1;
    if(idx < 0 || idx > 8) { alert("åªèƒ½èª¿æ•´ 1~9 å±€"); return; }
    const input = document.querySelector(`.score-inp-${side}[data-idx="${idx}"]`);
    if(input) {
        input.value = Math.max(0, (parseInt(input.value)||0) + delta);
        recalcTotal();
    }
}
function recalcTotal() {
    let sumA = 0, sumH = 0;
    document.querySelectorAll('.score-inp-away').forEach(el => sumA += (parseInt(el.value)||0));
    document.querySelectorAll('.score-inp-home').forEach(el => sumH += (parseInt(el.value)||0));
    elTotalAway.innerText = sumA;
    elTotalHome.innerText = sumH;
    state.away_score = sumA;
    state.home_score = sumH;
}
function addPA() {
    const res = document.getElementById('pa_result').value;
    if (!res) return;

    const item = { result: res, inning: state.inning };
    if (!state.batter_pa_recent) state.batter_pa_recent = [];
    state.batter_pa_recent.push(item);
    if (state.batter_pa_recent.length > 5) state.batter_pa_recent.shift();

    // BSO è‡ªå‹•è™•ç†
    if (['K', 'FO', 'GO'].includes(res)) adj('outs', 1);
    if (res === 'BB') adj('balls', 0);

    // â­ æŠŠé€™å€‹æ‰“è€…çš„æ‰“å¸­ç´€éŒ„åŒæ­¥å­˜åˆ°å¾Œç«¯
    const batterName = state.batter || elBatterSelect.value || "";
    if (batterName) {
        socket.emit("save_batter_state", {
            batter: batterName,
            batter_pa_recent: state.batter_pa_recent
        });
    }

    document.getElementById('pa_result').value = "";
    renderAll();
}

// ================= 8. Broadcast =================
function broadcast() {
    // å¼·åˆ¶æ›´æ–° state çš„å±€æ•¸
    state.inning = `${state.inn_num}${state.inn_half}`;
    
    state.pitcher = document.getElementById('pitcher_select').value;
    state.batter = document.getElementById('batter_select').value;
    state.away_team = document.getElementById('away_team_input').value;
    state.home_team = document.getElementById('home_team_input').value;
    
    state.away_logo_url = buildLogoPath(document.getElementById('away_logo').value);
    state.home_logo_url = buildLogoPath(document.getElementById('home_logo').value);
    
    state.bases = [
        document.getElementById('base1').checked,
        document.getElementById('base2').checked,
        document.getElementById('base3').checked
    ];

    state.box_away = collectBoxData('away');
    state.box_home = collectBoxData('home');
    state.away_score = state.box_away.scores.reduce((a,b)=>a+b, 0);
    state.home_score = state.box_home.scores.reduce((a,b)=>a+b, 0);

    state.timer_str = document.getElementById('admin_timer_display').innerText;
    state.timer_alert = document.getElementById('admin_timer_display').classList.contains('timer-alert-mode');

    const payload = {
        ...state,
        bases: [...state.bases],
        batter_pa_recent: [...state.batter_pa_recent]
    };

    console.log("[Admin] Broadcasting...", payload);
    socket.emit('update', payload);

    elToast.style.top = "-50px";
    elToast.style.opacity = 1;
    setTimeout(() => { elToast.style.opacity = 0; }, 1500);
}

function collectBoxData(side) {
    const scores = [];
    document.querySelectorAll(`.score-inp-${side}`).forEach(el => scores.push(parseInt(el.value) || 0));
    const lineup = [];
    for(let i=0; i<9; i++) {
        const el = document.getElementById(`lineup-${side}-${i}`);
        lineup.push(el ? el.value : "(å¾…å®š)");
    }
    return {
        name: document.getElementById(`${side}_team_input`).value,
        scores: scores,
        H: parseInt(document.getElementById(`${side}_H`).value) || 0,
        E: parseInt(document.getElementById(`${side}_E`).value) || 0,
        lineup: lineup
    };
}

document.addEventListener('keydown', (e) => {
    if(['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;
    if(e.key === 'Enter') { broadcast(); e.preventDefault(); }
    if(e.key === '1') adj('balls', 1);
    if(e.key === '2') adj('strikes', 1);
    if(e.key === '3') adj('outs', 1);
    if(e.key === '+' || e.key === '=' || e.code === 'NumpadAdd') { adj('np', 1); e.preventDefault(); }
    if(e.key === '-' || e.key === '_' || e.code === 'NumpadSubtract') { adj('np', -1); e.preventDefault(); }
});

renderAll();
updatePitcherBatterLists();
</script>
</body>
</html>