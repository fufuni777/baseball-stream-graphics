<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>棒球轉播計分板</title>
<style>
body {
    font-family: "Noto Sans TC", sans-serif;
    background: #111;
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 0;
}

.scoreboard-container {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: inline-block;
    width: 650px; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    overflow: hidden;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.7);
    padding: 5px 15px;
    font-size: 0.9em;
}

.main-score-row {
    display: flex;
    align-items: center;
    background: #003366;
    padding: 10px 15px;
    position: relative;
    border-bottom: 2px solid #001f3f;
}

/* 隊徽/文字顯示區塊 */
.team-logo {
    display: flex;
    flex-direction: column; /* 允許垂直堆疊 */
    align-items: center;
    justify-content: center;
    font-size: 3em;
    font-weight: bold;
    margin: 0 10px;
    color: #fff;
    text-shadow: 1px 1px 2px #000;
    min-width: 100px; /* 確保有足夠的空間 */
}

.team-logo img {
    max-width: 60px; /* Logo 圖片大小 */
    max-height: 60px;
    object-fit: contain;
    margin-bottom: 5px;
}

.score {
    font-size: 4em;
    font-weight: bold;
    padding: 5px 15px;
    border-radius: 5px;
    line-height: 1;
    color: #fff;
    background: #003366; 
    transition: background-color 0.2s ease-in-out; 
}

.away-score-box {
    margin-right: 10px;
}

.home-score-box {
    margin-left: 10px;
}

/* 分數閃爍高亮效果 */
.score.score-flash {
    background-color: #ffcc00; 
    color: #003366; 
}


/* 壘包佈局調整：Diamond Field 結構 - 確保不突出 */
.bases-display {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 100px;
    height: 100px;
    display: block;
}

.base-diamond {
    position: absolute;
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(45deg); 
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.5);
}

.base-diamond.active {
    background: #ffcc00;
    border: 1px solid #ffaa00;
}

/* 壘包位置定義 (相對於 100x100 的容器，確保不突出) */
#b1 { /* 一壘 (右側) */
    top: 50%;
    right: 5px;
    transform: translateY(-50%) rotate(45deg);
}

#b2 { /* 二壘 (上側) */
    top: 5px;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
}

#b3 { /* 三壘 (左側) */
    top: 50%;
    left: 5px;
    transform: translateY(-50%) rotate(45deg);
}


.bottom-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #001f3f;
    padding: 8px 15px;
    font-size: 1.1em;
}

.inning-info {
    display: flex;
    align-items: center;
    font-weight: bold;
    min-width: 100px;
}

.batter-info {
    flex-grow: 1;
    text-align: left;
    margin-right: 10px;
}

.count-outs {
    display: flex;
    align-items: center;
    font-weight: bold;
}

.ball-strike-out {
    display: flex;
    align-items: center;
    margin-left: 15px;
}

.count-label {
    margin-right: 5px;
    color: #fff;
}

.count-dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    margin: 0 3px;
    border: 1px solid #fff;
}

.ball-dot { background-color: #00cc00; }
.strike-dot { background-color: #ffcc00; }
.out-dot { background-color: #ff0000; }
.count-dot.inactive {
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.5);
}

.data-field { margin: 0 5px; }

</style>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<div class="scoreboard-container">
  <div class="top-bar">
    <div class="top-bar-left">
      <div class="data-field" id="pitcher_info">P {{ data.pitcher }}</div>
    </div>
    <div class="top-bar-right">
      <div class="data-field" id="np_info">NP: {{ data.np }}</div>
    </div>
  </div>

  <div class="main-score-row">
    <div class="team-logo" id="away_team_logo">
      <script>
        // 初始載入時，如果模板有提供 logo_url，則用 JS 替換內容
        if ('{{ data.away_logo_url }}') {
            document.write('<img src="{{ data.away_logo_url }}" alt="{{ data.away_team }}">');
        }
      </script>
      <span>{{ data.away_team }}</span>
    </div> 
    
    <div class="score away-score-box" id="away_score">{{ data.away_score }}</div>
    
    <div class="team-logo" id="home_team_logo">
      <script>
        if ('{{ data.home_logo_url }}') {
            document.write('<img src="{{ data.home_logo_url }}" alt="{{ data.home_team }}">');
        }
      </script>
      <span>{{ data.home_team }}</span>
    </div> 
    
    <div class="score home-score-box" id="home_score">{{ data.home_score }}</div>

    <div class="bases-display">
      <div class="base-diamond {{ 'active' if data.bases[0] else '' }}" id="b1"></div>
      <div class="base-diamond {{ 'active' if data.bases[1] else '' }}" id="b2"></div>
      <div class="base-diamond {{ 'active' if data.bases[2] else '' }}" id="b3"></div>
    </div>
  </div>

  <div class="bottom-info-row">
    <div class="inning-info">
      <div id="inning">{{ data.inning }}</div> 
    </div>
    <div class="batter-info">
      <div id="batter_name">{{ data.batter }}</div>
      <div id="batter_avg">AVG {{ data.avg }}</div>
    </div>
    <div class="count-outs">
      <div class="ball-strike-out">
        <span class="count-label">B</span>
        <span class="count-dot ball-dot" id="ball1"></span>
        <span class="count-dot ball-dot" id="ball2"></span>
        <span class="count-dot ball-dot" id="ball3"></span>
        <span class="count-dot ball-dot" id="ball4"></span>
      </div>
      
      <div class="ball-strike-out">
        <span class="count-label">S</span>
        <span class="count-dot strike-dot" id="strike1"></span>
        <span class="count-dot strike-dot" id="strike2"></span>
        <span class="count-dot strike-dot" id="strike3"></span>
      </div>

      <div class="ball-strike-out">
        <span class="count-label">O</span>
        <span class="count-dot out-dot" id="out1"></span>
        <span class="count-dot out-dot" id="out2"></span>
        <span class="count-dot out-dot" id="out3"></span>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io();
// 追蹤上一次的分數
let lastScores = {
    away_score: parseInt('{{ data.away_score }}') || 0,
    home_score: parseInt('{{ data.home_score }}') || 0
};
const FLASH_DURATION = 1500; 

function flashScore(elementId, newScore, oldScore) {
    const newS = parseInt(newScore);
    const oldS = parseInt(oldScore);
    if (newS > oldS) {
        const element = document.getElementById(elementId);
        element.classList.add('score-flash');

        setTimeout(() => {
            element.classList.remove('score-flash');
        }, FLASH_DURATION);
    }
}

function updateDots(prefix, total, activeCount) {
    for (let i = 1; i <= total; i++) {
        const dot = document.getElementById(prefix + i);
        if (dot) {
            dot.classList.toggle('inactive', i > activeCount);
        }
    }
}

function updateBases(basesArray) {
    const baseIds = ['b1', 'b2', 'b3'];
    baseIds.forEach((id, index) => {
        const base = document.getElementById(id);
        if (base) {
            base.classList.toggle('active', basesArray[index]);
        }
    });
}

function formatInning(inningStr) {
    if (typeof inningStr === 'string') {
        return inningStr.replace('上', ' △').replace('下', ' ▽');
    }
    return inningStr;
}

function updateTeamLogo(teamElementId, teamName, logoUrl) {
    const teamElement = document.getElementById(teamElementId);
    teamElement.innerHTML = ''; // 清空現有內容

    let textSpan = document.createElement('span');
    textSpan.textContent = teamName || '';
    
    if (logoUrl && logoUrl.trim() !== '') {
        const img = document.createElement('img');
        img.src = logoUrl;
        img.alt = teamName;
        teamElement.appendChild(img);
        teamElement.style.fontSize = '1.5em'; 
    } else {
        teamElement.style.fontSize = '3em'; // 如果沒有 Logo，使用原始大字體
    }
    
    teamElement.appendChild(textSpan);
}


socket.on('update', data => {
    const mergedData = { 
        away_team: '客隊', home_team: '主隊', away_score: 0, home_score: 0,
        inning: '1上', pitcher: '投手', batter: '打者', np: 0, avg: '.000',
        balls: 0, strikes: 0, outs: 0, bases: [false, false, false],
        away_logo_url: '', home_logo_url: '', // 確保有預設值
        ...data
    };

    const currentAwayScore = parseInt(mergedData.away_score);
    const currentHomeScore = parseInt(mergedData.home_score);

    // 1. 處理分數高亮
    flashScore('away_score', currentAwayScore, lastScores.away_score);
    flashScore('home_score', currentHomeScore, lastScores.home_score);
    
    // 2. 更新隊徽/隊名
    updateTeamLogo('away_team_logo', mergedData.away_team, mergedData.away_logo_url);
    updateTeamLogo('home_team_logo', mergedData.home_team, mergedData.home_logo_url);

    // 3. 更新其他資訊
    document.getElementById('away_score').textContent = currentAwayScore;
    document.getElementById('home_score').textContent = currentHomeScore;
    document.getElementById('pitcher_info').textContent = `P ${mergedData.pitcher}`;
    document.getElementById('np_info').textContent = `NP: ${mergedData.np}`;
    document.getElementById('inning').textContent = formatInning(mergedData.inning);
    document.getElementById('batter_name').textContent = mergedData.batter;
    document.getElementById('batter_avg').textContent = `AVG ${mergedData.avg}`;

    updateDots('ball', 4, mergedData.balls);
    updateDots('strike', 3, mergedData.strikes);
    updateDots('out', 3, mergedData.outs);
    updateBases(mergedData.bases);

    // 4. 更新 lastScores 供下次比較
    lastScores.away_score = currentAwayScore;
    lastScores.home_score = currentHomeScore;
});

window.onload = () => {
    const initialInning = document.getElementById('inning');
    if (initialInning) {
        initialInning.textContent = formatInning(initialInning.textContent.trim());
    }
    // 初始載入時也要確保隊伍 logo/文字正確顯示
    updateTeamLogo('away_team_logo', document.querySelector('#away_team_logo span').textContent, '{{ data.away_logo_url }}');
    updateTeamLogo('home_team_logo', document.querySelector('#home_team_logo span').textContent, '{{ data.home_logo_url }}');
};
</script>
</body>
</html>