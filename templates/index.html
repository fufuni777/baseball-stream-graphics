<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>棒球轉播計分板</title>
<style>
body {
    font-family: "Noto Sans TC", sans-serif;
    background: #111;
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 0;
}

.scoreboard-container {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: inline-block;
    width: 650px; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    overflow: hidden;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.7);
    /* 修改處：左右 padding 皆設為 15px，讓 inning 靠右時有對稱的邊距 */
    padding: 5px 15px;
    font-size: 0.9em;
}


.top-bar-left {
    display: flex;
    align-items: center;
    gap: 12px;    /* 投手與 NP 之間的距離 */
}

.top-bar-right {
    display: flex;
    align-items: center;
}

/* 投手 / NP 字體 */
#pitcher_info {
    font-size: 1.5em;
    font-weight: bold;
}

#np_info {
    font-size: 1.5em;
}

.main-score-row {
    display: flex;
    align-items: center;
    background: #003366;
    padding: 10px 15px;
    position: relative;
    border-bottom: 2px solid #001f3f;
}

/* 隊徽/文字容器 */
.team-logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 10px;
    max-width: 190px;        /* 給隊名一個合理寬度，避免擠到壘包 */
    text-align: center;
}

/* 隊名文字：最多兩行，上下堆疊 */
.team-logo span {
    font-size: 1.35em;       /* 縮小一點的隊名字體 */
    line-height: 1.1;
    font-weight: bold;
    color: #fff;
    text-shadow: 1px 1px 2px #000;

    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;   /* ✅ 最多兩行 */
    overflow: hidden;        /* 超過兩行就裁掉 */
    word-break: break-word;  /* 中英文都可中間換行 */
}

.team-logo img {
    max-width: 100px;
    max-height: 100px;
    object-fit: contain;
    margin-bottom: 5px;
}

.score {
    font-size: 4em;
    font-weight: bold;
    padding: 5px 15px;
    border-radius: 5px;
    line-height: 1;
    color: #fff;
    background: #003366; 
    transition: background-color 0.2s ease-in-out; 
}

.away-score-box {
    margin-right: 10px;
}

.home-score-box {
    margin-left: 10px;
}

/* 分數閃爍高亮效果 */
.score.score-flash {
    background-color: #ffcc00; 
    color: #003366; 
}

/* 壘包：二壘在上，一壘右下，三壘左下 */
.bases-display {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 90px;   /* 座標系寬 */
    height: 90px;  /* ✅ 一定要有高度 */
    pointer-events: none;
    z-index: 10;
}

.base-diamond {
    position: absolute;
    width: 26px;   /* ✅ 壘包加大 */
    height: 26px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%) rotate(45deg);  /* 用中心點定位 */
}

.base-diamond.active {
    background: #ffcc00;
    border: 1px solid #ffaa00;
}

/* 一壘：右下 */
#b1 { /* 一壘 (右側) */
    top: 74%;   /* 底邊的位置 */
    left: 78%;  /* 右邊一點 */
}

#b2 { /* 二壘 (上側) */
    top: 40%;
    left: 50%;
}

#b3 { /* 三壘 (左側) */
    top: 74%;
    left: 22%;  /* 左邊一點 */
}

.bottom-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #001f3f;
    padding: 8px 15px;
    font-size: 1.1em;
    gap: 20px;
}

.inning-info {
    display: flex;
    align-items: center;
    /* 修改處：強制內容靠右對齊 */
    justify-content: flex-end; 
    text-align: right;
    
    font-weight: bold;
    min-width: 100px;
}

.batter-info {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    margin-right: 10px;
    white-space: nowrap;
}

.batter-pa {
    font-size: 0.8em;
    opacity: 0.9;
    overflow: hidden;
    text-overflow: ellipsis;
}

.count-outs {
    display: flex;
    align-items: center;
    font-weight: bold;
}

.ball-strike-out {
    display: flex;
    align-items: center;
    margin-left: 15px;
}

.count-label {
    margin-right: 5px;
    color: #fff;
}

.count-dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    margin: 0 3px;
    border: 1px solid #fff;
}

.ball-dot { background-color: #00cc00; }
.strike-dot { background-color: #ffcc00; }
.out-dot { background-color: #ff0000; }
.count-dot.inactive {
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.5);
}

.data-field { margin: 0 5px; }

</style>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<div class="scoreboard-container">
  <div class="top-bar">
    <div class="top-bar-left">
      <div class="data-field" id="pitcher_info">P {{ data.pitcher }}</div>
      <div class="data-field" id="np_info">NP: {{ data.np }}</div>
    </div>
    <div class="top-bar-right">
      <div class="inning-info">
        <div id="inning">{{ data.inning }}</div> 
      </div>
    </div>
  </div>

  <div class="main-score-row">
    <div class="team-logo" id="away_team_logo">
      <script>
        if ('{{ data.away_logo_url }}') {
            document.write('<img src="{{ data.away_logo_url }}" alt="{{ data.away_team }}">');
        }
      </script>
      <span>{{ data.away_team }}</span>
    </div> 
    
    <div class="score away-score-box" id="away_score">{{ data.away_score }}</div>
    
    <div class="team-logo" id="home_team_logo">
      <script>
        if ('{{ data.home_logo_url }}') {
            document.write('<img src="{{ data.home_logo_url }}" alt="{{ data.home_team }}">');
        }
      </script>
      <span>{{ data.home_team }}</span>
    </div> 
    
    <div class="score home-score-box" id="home_score">{{ data.home_score }}</div>

    <div class="bases-display">
      <div class="base-diamond {{ 'active' if data.bases[0] else '' }}" id="b1"></div>
      <div class="base-diamond {{ 'active' if data.bases[1] else '' }}" id="b2"></div>
      <div class="base-diamond {{ 'active' if data.bases[2] else '' }}" id="b3"></div>
    </div>
  </div>

  <div class="bottom-info-row">
    <div class="batter-info">
        <span id="batter_name">{{ data.batter }}</span>
        <span id="batter_pa_recent" class="batter-pa"></span>
      </div>
    <div class="count-outs">
      <div class="ball-strike-out">
        <span class="count-label">B</span>
        <span class="count-dot ball-dot" id="ball1"></span>
        <span class="count-dot ball-dot" id="ball2"></span>
        <span class="count-dot ball-dot" id="ball3"></span>
      </div>
      
      <div class="ball-strike-out">
        <span class="count-label">S</span>
        <span class="count-dot strike-dot" id="strike1"></span>
        <span class="count-dot strike-dot" id="strike2"></span>
      </div>

      <div class="ball-strike-out">
        <span class="count-label">O</span>
        <span class="count-dot out-dot" id="out1"></span>
        <span class="count-dot out-dot" id="out2"></span>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io();

// 核心版本號，和 full_board 一樣概念
let lastCoreVersion = {{ data.core_version or 0 }};

// 追蹤上一次的分數
let lastScores = {
    away_score: parseInt('{{ data.away_score }}') || 0,
    home_score: parseInt('{{ data.home_score }}') || 0
};

const FLASH_DURATION = 1500; 

function flashScore(elementId, newScore, oldScore) {
    const newS = parseInt(newScore);
    const oldS = parseInt(oldScore);
    if (newS > oldS) {
        const element = document.getElementById(elementId);
        element.classList.add('score-flash');
        setTimeout(() => {
            element.classList.remove('score-flash');
        }, FLASH_DURATION);
    }
}

function updateDots(prefix, total, activeCount) {
    for (let i = 1; i <= total; i++) {
        const dot = document.getElementById(prefix + i);
        if (dot) {
            dot.classList.toggle('inactive', i > activeCount);
        }
    }
}

function updateBases(basesArray) {
    const baseIds = ['b1', 'b2', 'b3'];
    baseIds.forEach((id, index) => {
        const base = document.getElementById(id);
        if (base) {
            base.classList.toggle('active', basesArray[index]);
        }
    });
}

function cleanName(raw) {
    if (!raw) return '';
    // 把前面像 "[10] " 或 "10 " 之類的背號切掉
    return String(raw)
        .replace(/^\s*\[[^\]]*]\s*/, '')   // 開頭是 [10] 這種
        .replace(/^\s*\d+\s*/, '')         // 開頭是 10 空白 這種
        .trim();
}


function formatInning(inningStr) {
    if (typeof inningStr === 'string') {
        return inningStr.replace('上', ' △').replace('下', ' ▽');
    }
    return inningStr;
}

function updateTeamLogo(teamElementId, teamName, logoUrl) {
    const teamElement = document.getElementById(teamElementId);
    teamElement.innerHTML = '';

    let textSpan = document.createElement('span');
    textSpan.textContent = teamName || '';
    
    if (logoUrl && logoUrl.trim() !== '') {
        const img = document.createElement('img');
        img.src = logoUrl;
        img.alt = teamName;
        teamElement.appendChild(img);
    }
    
    teamElement.appendChild(textSpan);
}

socket.on('update', data => {
    console.log("update raw data =", data);
    
    // 1. 先根據 core_version 判斷：有沒有「記分板內容」更新
    const oldVersion = lastCoreVersion;
    const newVersion = (data.core_version ?? oldVersion);

    // 如果版本沒變，代表這次可能只是 timer 更新之類的，index 就直接忽略
    if (newVersion === oldVersion) {
        return;
    }
    lastCoreVersion = newVersion;
    
    const mergedData = { 
        away_team: '客隊', home_team: '主隊', away_score: 0, home_score: 0,
        inning: '1上', pitcher: '投手', batter: '打者', np: 0,
        balls: 0, strikes: 0, outs: 0, bases: [false, false, false],
        away_logo_url: '', home_logo_url: '',
        batter_pa_recent: [],
        ...data
    };

    const currentAwayScore = parseInt(mergedData.away_score);
    const currentHomeScore = parseInt(mergedData.home_score);

    // 1. 分數高亮
    flashScore('away_score', currentAwayScore, lastScores.away_score);
    flashScore('home_score', currentHomeScore, lastScores.home_score);
    
    // 2. 隊徽/隊名
    updateTeamLogo('away_team_logo', mergedData.away_team, mergedData.away_logo_url);
    updateTeamLogo('home_team_logo', mergedData.home_team, mergedData.home_logo_url);

    // 3. 其他資訊
    document.getElementById('away_score').textContent = currentAwayScore;
    document.getElementById('home_score').textContent = currentHomeScore;
    document.getElementById('pitcher_info').textContent = `P ${cleanName(mergedData.pitcher)}`;    
    document.getElementById('np_info').textContent = `NP: ${mergedData.np}`;
    document.getElementById('inning').textContent = formatInning(mergedData.inning);
    document.getElementById('batter_name').textContent = `H ${cleanName(mergedData.batter)}`;    
    // 顯示目前打者最近幾次打席
    const paRecentDiv = document.getElementById('batter_pa_recent');
    if (paRecentDiv) {
        const arr = mergedData.batter_pa_recent || [];

        if (Array.isArray(arr) && arr.length > 0) {
            // 只顯示 result
            const results = arr
                .map(item => (item && item.result ? String(item.result) : ''))
                .filter(x => x !== '');
            
            paRecentDiv.textContent = results.join(' ／ ');
        } else {
            paRecentDiv.textContent = '';
        }
    }


    // B: 3 顆, S: 2 顆, O: 2 顆
    updateDots('ball', 3, mergedData.balls);
    updateDots('strike', 2, mergedData.strikes);
    updateDots('out', 2, mergedData.outs);
    updateBases(mergedData.bases);

    lastScores.away_score = currentAwayScore;
    lastScores.home_score = currentHomeScore;
});

window.onload = () => {
    const initialInning = document.getElementById('inning');
    if (initialInning) {
        initialInning.textContent = formatInning(initialInning.textContent.trim());
    }
    updateTeamLogo(
        'away_team_logo',
        document.querySelector('#away_team_logo span').textContent,
        '{{ data.away_logo_url }}'
    );
    updateTeamLogo(
        'home_team_logo',
        document.querySelector('#home_team_logo span').textContent,
        '{{ data.home_logo_url }}'
    );
};
</script>
</body>
</html>